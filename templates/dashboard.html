{% extends '_base.html' %} {% load static %} {% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">
                  Atendimentos de hoje
                </p>
                <h5 class="font-weight-bolder">{{ context.today_sessions }}</h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div
                class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle"
              >
                <i
                  class="ni ni-money-coins text-lg opacity-10"
                  aria-hidden="true"
                ></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-uppercase font-weight-bold">
                  Alunos cadastrados
                </p>
                <h5 class="font-weight-bolder">{{ context.students }}</h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div
                class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle"
              >
                <i
                  class="ni ni-world text-lg opacity-10"
                  aria-hidden="true"
                ></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-lg-7 mb-lg-0 mb-4">
        <div class="card z-index-2 h-100">
          <div class="card-header pb-0 pt-3 bg-transparent">
            <h6 class="text-capitalize">Visão geral de agendamentos</h6>
            <p class="text-sm mb-0">
              <i class="fa fa-calendar text-primary"></i>
              <span class="font-weight-bold"
                >Tendência mensal de agendamentos</span
              >
            </p>
          </div>
          <div class="card-body p-3">
            <div class="chart">
              <canvas
                id="appointments-chart"
                class="chart-canvas"
                height="250"
                style="height: 350px"
              ></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card h-100">
          <div class="card-header pb-0 pt-3 bg-transparent">
            <h6 class="text-capitalize">Agende um atendimento</h6>
          </div>
          <div class="card-body p-3">
            <form method="post">
              {% csrf_token %}
              <div class="mb-3">
                <label for="{{ form.students.id_for_label }}" class="form-label"
                  >Aluno</label
                >
                {{ form.students }} {{ form.students.errors }}
              </div>
              <div class="mb-3">
                <label for="{{ form.date.id_for_label }}" class="form-label"
                  >Data</label
                >
                {{ form.date }} {{ form.date.errors }}
              </div>
              <div class="mb-3">
                {{ form.time.label_tag }} {{ form.time }} {{ form.time.errors }}
              </div>
              <div class="mb-3">
                <label for="{{ form.place.id_for_label }}" class="form-label"
                  >Local</label
                >
                {{ form.place }} {{ form.place.errors }}
              </div>
              <div class="mb-3">
                <label for="{{ form.notes.id_for_label }}" class="form-label"
                  >Notas</label
                >
                {{ form.notes }} {{ form.notes.errors }}
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Agendar atendimento
              </button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12 mt-4" id="table-results">
        <div class="card mb-4 shadow-lg">
          <div class="card-header pb-0 pt-3 bg-transparent d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-capitalize mb-0">Todos os Agendamentos</h6>
              <p class="text-sm text-muted mb-0">
                Veja seus agendamentos programados abaixo.
              </p>
            </div>

            <form method="get" class="d-flex ms-auto" id="search-form">
              <div class="input-group input-group-sm">
                <span class="input-group-text text-body"
                  ><i class="fas fa-search" aria-hidden="true"></i
                ></span>
                <input
                  type="text"
                  name="q"
                  class="form-control"
                  placeholder="Buscar aluno, local..."
                  value="{{ context.search_query }}"
                />
              </div>
            </form>
          </div>

          <div class="card-body px-0 pt-0 pb-2">
            <div class="table-responsive p-0">
              <table
                class="table align-items-center mb-0 table-hover table-striped table-bordered"
              >
                <thead>
                  <tr>
                    <th
                      class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7 ps-3"
                    >
                      Aluno
                    </th>
                    <th
                      class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7"
                    >
                      Data
                    </th>
                    <th
                      class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7"
                    >
                      Hora
                    </th>
                    <th
                      class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7"
                    >
                      Local
                    </th>
                    <th
                      class="text-center text-uppercase text-secondary text-xs font-weight-bolder opacity-7 pe-3"
                    >
                      Ações
                    </th>
                  </tr>
                </thead>

                <tbody>
                  {% for session in context.sessions %}
                  <tr>
                    <td class="ps-3">
                      <div class="d-flex align-items-center">
                        <div class="d-flex flex-column justify-content-center">
                          {% for student in session.students.all %}
                          <h6 class="mb-0 text-dark">
                            {{ student.user.name }}
                          </h6>
                          {% empty %}
                          <h6 class="mb-0 text-sm text-muted fst-italic">—</h6>
                          {% endfor %}
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="font-weight-normal mb-0">
                        {{ session.date|date:"d/m/Y" }}
                      </p>
                    </td>
                    <td>
                      <span class="font-weight-normal mb-0"
                        >{{ session.time }}</span
                      >
                    </td>
                    <td>
                      <p class="font-weight-normal mb-0">{{ session.place }}</p>
                    </td>

                    <td class="align-middle text-center">
                      <div class="d-flex justify-content-center gap-2">
                        {% with first_student=session.students.first %}
                        <a
                          href="{% if first_student %}{% url 'profile_view' first_student.id %}{% else %}#{% endif %}"
                          class="btn btn-info btn-sm mb-0"
                        >
                          <i class="fa fa-eye"></i>
                        </a>
                        {% endwith %}
                        <a href="#" class="btn btn-warning btn-sm mb-0"
                          ><i class="fa fa-edit"></i
                        ></a>
                        <form
                          action="{% url 'delete_session' session.id %}"
                          method="post"
                          class="d-inline mb-0"
                        >
                          {% csrf_token %}
                          <button
                            type="submit"
                            class="btn btn-danger btn-sm mb-0"
                            onclick="return confirm('Excluir?');"
                          >
                            <i class="fa fa-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <p class="text-muted mb-0">
                        Nenhum agendamento encontrado.
                      </p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            {% if context.sessions.has_other_pages %}
            <div class="d-flex justify-content-center mt-4">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        
                        {% if context.sessions.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ context.sessions.previous_page_number }}{% if context.search_query %}&q={{ context.search_query }}{% endif %}" aria-label="Previous">
                                    <i class="fa fa-angle-left"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="fa fa-angle-left"></i></span>
                            </li>
                        {% endif %}

                        {% for i in context.sessions.paginator.page_range %}
                            
                            {% if i == context.sessions.paginator.page_range.start or i == context.sessions.paginator.page_range.stop|add:"-1" or i >= context.sessions.number|add:"-2" and i <= context.sessions.number|add:"2" %}
                                
                                {% if context.sessions.number == i %}
                                    <li class="page-item active">
                                        <span class="page-link text-white">{{ i }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ i }}{% if context.search_query %}&q={{ context.search_query }}{% endif %}">
                                            {{ i }}
                                        </a>
                                    </li>
                                {% endif %}

                            {% endif %}
                            {% endfor %}

                        {% if context.sessions.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ context.sessions.next_page_number }}{% if context.search_query %}&q={{ context.search_query }}{% endif %}" aria-label="Next">
                                    <i class="fa fa-angle-right"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="fa fa-angle-right"></i></span>
                            </li>
                        {% endif %}

                    </ul>
                </nav>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {{ context.chart_months|json_script:"months-data" }} 
  {{ context.chart_counts|json_script:"counts-data" }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const chartElement = document.getElementById("appointments-chart");

      if (chartElement) {
        const chartCtx = chartElement.getContext("2d");

        // 2. O JavaScript lê os dados do HTML de forma limpa (sem erro de sintaxe)
        const chartLabels = JSON.parse(
          document.getElementById("months-data").textContent
        );
        const chartData = JSON.parse(
          document.getElementById("counts-data").textContent
        );

        new Chart(chartCtx, {
          type: "line",
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: "Atendimentos",
                data: chartData, // Dados vindo do Django
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: "rgba(54, 162, 235, 1)",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
              },
            },
          },
        });
      }
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Função para atualizar a tabela via AJAX
      function updateTable(url) {
        // Mostra uma opacidade para indicar carregamento (opcional)
        const container = document.getElementById("table-results");
        container.style.opacity = "0.5";

        fetch(url)
          .then((response) => response.text())
          .then((html) => {
            // Converte o texto recebido em HTML real
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // Pega apenas o novo conteúdo da tabela e substitui o atual
            const newContent = doc.getElementById("table-results").innerHTML;
            container.innerHTML = newContent;

            // Remove a opacidade
            container.style.opacity = "1";
          })
          .catch((error) => console.error("Erro ao atualizar tabela:", error));
      }

      // 1. Interceptar o envio do formulário de busca
      const searchForm = document.getElementById("search-form");
      if (searchForm) {
        searchForm.addEventListener("submit", function (e) {
          e.preventDefault(); // Impede o reload
          const formData = new FormData(searchForm);
          const params = new URLSearchParams(formData);
          const url = `${window.location.pathname}?${params.toString()}`;

          // Atualiza a URL do navegador sem recarregar (para poder compartilhar o link)
          window.history.pushState({}, "", url);

          updateTable(url);
        });
      }

      // 2. Interceptar cliques na paginação (Delegação de Eventos)
      // Usamos delegação porque os botões de paginação são substituídos dinamicamente
      document
        .getElementById("table-results")
        .addEventListener("click", function (e) {
          // Verifica se o clique foi em um link de paginação (tag <a> ou ícone dentro de <a>)
          const link = e.target.closest(".page-link");

          if (
            link &&
            link.getAttribute("href") &&
            link.getAttribute("href") !== "#"
          ) {
            e.preventDefault(); // Impede o reload
            const url = link.getAttribute("href");

            // Atualiza a URL do navegador
            window.history.pushState({}, "", url);

            updateTable(url);
          }
        });

      // 3. Opcional: Busca dinâmica enquanto digita (Live Search)
      const searchInput = searchForm.querySelector("input[name='q']");
      let timeout = null;
      searchInput.addEventListener("input", function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          searchForm.dispatchEvent(new Event("submit"));
        }, 500); // Aguarda meio segundo após parar de digitar
      });
    });
  </script>
  {% endblock content %}
</div>
